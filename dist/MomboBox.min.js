/*! User Modifiable Combobox - v0.1.0 - 2012-10-01
* https://github.com/luv2code/MomboBox
* Copyright (c) 2012 Matthew Taylor; Licensed MIT, GPL */
(function(e){var t={data:[],templates:{buttonTemplate:'<button class="mombobutton">â†“</button>',itemTemplate:'<a class="item">{item}</a>',menuTemplate:'<div class="mombomenu"></div>',render:function(e,t,n){return e.replace("{"+n+"}",t)}},cssClasses:{matchingItem:"match",selectedItem:"selected",item:"item",menu:"mombomenu"},flags:{customItems:!0,addCustomItems:!0,hideUnmatchedItems:!0,prependCustom:!0}};e.fn.momboBox=function(n){return this.each(function(){if(this.nodeName!=="INPUT")throw new Error("the momboBox plugin only works on input elements");var r=this.momboBox=e.extend({},t,n),i="",s,o=e(this),u=o.val(),a=o.val,f=e(r.templates.buttonTemplate).insertAfter(o),l,c=o.offset(),h=c.top+o.outerHeight(),p=c.left,d=function(){i="",e.each(r.data,function(e,t){i+=r.templates.render(r.templates.itemTemplate,t,"item")}),l.empty(),s=e(i).appendTo(l)},v=function(){var t,n=new RegExp("("+o.val()+")","i");s.each(function(t,i){var s=e(i),o=s.text();n.test(o)?s.addClass(r.cssClasses.matchingItem):s.removeClass(r.cssClasses.matchingItem)}),t=s.siblings("."+r.cssClasses.matchingItem).first(),t.length>0&&l.scrollTop(t.position().top)},m=function(e){var t=r.flags.prependCustom?"unshift":"push";r.data[t](e),d(),v()};o.val=function(e,t){return typeof e=="string"?(u=t?u:e,a.call(o,e)):a.call(o)},!r.flags.customItems&&!!r.data&&r.data.length>0&&o.val(r.data[0]),l=e(r.templates.menuTemplate).insertAfter(f).offset({top:h,left:p}).on("click","."+r.cssClasses.item,function(t){o.val(e(t.target).text()),l.fadeOut("fast"),s.removeClass(r.cssClasses.matchingItem)}).on("mouseover","."+r.cssClasses.item,function(t){s.removeClass(r.cssClasses.selectedItem),e(t.target).addClass(r.cssClasses.selectedItem)}).hide(),d(),e(document).on("click",function(){!o.is(":momboFocus")&&!f.is(":momboFocus")&&l.fadeOut("fast")}),f.on("click",function(){o.focus()}),o.on("added-custom",function(e,t){!e.isPropagationStopped()&&r.flags.addCustomItems&&m(t)}).on("focus",function(){o.select(),l.show()}).on("keydown",function(t){var n=s.siblings("."+r.cssClasses.selectedItem),i=0,a=s.length-1,f,c,h;t.which!==27&&l.show(),n.toggleClass(r.cssClasses.selectedItem+" "+r.cssClasses.matchingItem);switch(t.which){case 38:n.length>0?s.each(function(t,o){o===n.get(0)&&(i=t===0?a:i,f=e(s[i]).addClass(r.cssClasses.selectedItem+" "+r.cssClasses.matchingItem).text(),c=e(s[i]).position().top),i=t}):(f=s.last().addClass(r.cssClasses.selectedItem+" "+r.cssClasses.matchingItem).text(),c=s.last().position().top),o.val(f,!0),l.scrollTop(c);break;case 40:n.length>0?s.each(function(t,o){i=t+1,o===n.get(0)&&(i=t===a?0:i,f=e(s[i]).addClass(r.cssClasses.selectedItem+" "+r.cssClasses.matchingItem).text(),c=e(s[i]).position().top)}):(f=s.last().addClass(r.cssClasses.selectedItem+" "+r.cssClasses.matchingItem).text(),c=s.first().position().top),o.val(f,!0),l.scrollTop(c);break;case 27:l.fadeOut("fast"),o.val(u);break;case 9:l.fadeOut("fast");break;case 13:v(),h=s.siblings("."+r.cssClasses.matchingItem),h.length>0?o.val(h.first().text()):r.flags.customItems?o.trigger("added-custom",[o.val()]):o.val(u),l.fadeOut("fast")}}).on("keyup",function(e){var t;v()})})},e.expr[":"].momboFocus=function(e){return e===document.activeElement&&(e.type||e.href)}})(jQuery);